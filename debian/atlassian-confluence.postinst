#!/bin/bash

set -euxo pipefail

CONFLUENCE_DOWNLOAD_URL=http://product-downloads.atlassian.com/software/confluence/downloads/atlassian-confluence-7.19.17.tar.gz
CONFLUENCE_DOWNLOAD_DEST=/tmp/atlassian-confluence-7.19.17.tar.gz
CONFLUENCE_DOWNLOAD_CHECKSUM=e14447b8e0a7e8bff3baa461fc3f23f55e9e788829f41d30a90d596c27e662e0

CONFLUENCE_CATALINA=/opt/atlassian/confluence
CONFLUENCE_PATCH=/opt/atlassian/atlassian-confluence.patch

wget -c $CONFLUENCE_DOWNLOAD_URL -O $CONFLUENCE_DOWNLOAD_DEST
echo -n "$CONFLUENCE_DOWNLOAD_CHECKSUM $CONFLUENCE_DOWNLOAD_DEST" | sha256sum -c -

rm -rf $CONFLUENCE_CATALINA
mkdir -p $CONFLUENCE_CATALINA
tar zxf $CONFLUENCE_DOWNLOAD_DEST -C $CONFLUENCE_CATALINA --strip-components=1

cat $CONFLUENCE_PATCH | patch -p1 -d /
chmod a+x $CONFLUENCE_CATALINA/bin/start-confluence.sh
chmod a+x $CONFLUENCE_CATALINA/bin/stop-confluence.sh
find $CONFLUENCE_CATALINA -type f -name '*.so' -exec chrpath -d {} \;
find $CONFLUENCE_CATALINA -type f -name '*.bak' -delete
find $CONFLUENCE_CATALINA -type f -name '*.orig' -delete
find $CONFLUENCE_CATALINA -type f -name '*.rej' -delete
fdupes -qnrps $CONFLUENCE_CATALINA

chown -Rf confluence:confluence $CONFLUENCE_CATALINA
chmod 0700 $CONFLUENCE_CATALINA

#DEBHELPER#

exit 0
